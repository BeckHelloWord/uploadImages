
{% extends 'base.html' %}

{% block body %}
<div class="img-file">
    <div class="img-item first">
        <img class="file-img" src="" />
        <img class="close" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABBAAD/4QMraHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjMtYzAxMSA2Ni4xNDU2NjEsIDIwMTIvMDIvMDYtMTQ6NTY6MjcgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLyIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDUzYgKFdpbmRvd3MpIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkE4NTg1NzBEREI3MzExRTU4Qzk2RDBBRThBMDdBODg2IiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkE4NTg1NzBFREI3MzExRTU4Qzk2RDBBRThBMDdBODg2Ij4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QTg1ODU3MEJEQjczMTFFNThDOTZEMEFFOEEwN0E4ODYiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QTg1ODU3MENEQjczMTFFNThDOTZEMEFFOEEwN0E4ODYiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz7/7gAmQWRvYmUAZMAAAAABAwAVBAMGCg0AAAUdAAAFdAAABeYAAAZX/9sAhAAFBAQEBAQFBAQFBwUEBQcJBwUFBwkKCAgJCAgKDQoLCwsLCg0MDAwNDAwMDw8REQ8PFxYWFhcZGRkZGRkZGRkZAQYGBgoJChQNDRQWEQ4RFhkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRn/wgARCAAkACQDAREAAhEBAxEB/8QAnQABAAMBAQAAAAAAAAAAAAAAAAMEBQEGAQEAAAAAAAAAAAAAAAAAAAAAEAADAAMBAAAAAAAAAAAAAAABAgMQIARAEQABAQQHCQAAAAAAAAAAAAACAQASMgMQIBEhMeEiQWFxwdFCUhMEEgEAAAAAAAAAAAAAAAAAAABAEwEAAQMDBAMBAAAAAAAAAAABESExQQAQUSBA8GGRoeGx/9oADAMBAAIRAxEAAAHUAABqkJAVwXzUPOnAWCAmIAAAf//aAAgBAQABBQLZEn0zjzlzZkd8c8S5pRe9SCDhrO6AkGtWs23/2gAIAQIAAQUC9P8A/9oACAEDAAEFAvT/AP/aAAgBAgIGPwJP/9oACAEDAgY/Ak//2gAIAQEBBj8CrIAI59IbPPNlKZolBGXLi1ssXAwRKfYROSgiPpvZwNEwLwBe7NrFuVKRlrAGCI1qXKjPnFX/AP/aAAgBAQMBPyHqOgCmAvnx/HFz688NFowDKgy+3dxefLPGh06pQodUQWCNx3a4AooJ5eXQJLgS46oUoBQiYy++v//aAAgBAgMBPyHuf//aAAgBAwMBPyHuf//aAAwDAQACEQMRAAAQAAAEAEAAAAAAH//aAAgBAQMBPxDqcNGtB5VVQ+U0Rc9DwBjbq0Y+kxrBVQwKr7o/d0TPDsAVOdYi3wICYw092wAPKog9SNAKIju4swQyVSOWJ/dIPULQCoiar3o/0sULrL1//9oACAECAwE/EO5//9oACAEDAwE/EO5//9k=" />
    </div>
    <div class="file-btn">
        <input type="file" class="input-file" name="picture" multiple="multiple" />
    </div>
</div>
<div class="sub-btn">确认提交</div>

<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script>
    (function(){
        var fileChooser = $(".input-file"),
            fileBtn = $(".file-btn"),
            imgCont = $(".img-item"),
            maxsize = 100 * 1024,
            count = 0,
            sendVal = "";

        fileChooser.on("change", function(){
            // 把类数组的files对象转换为数组
            var files = Array.prototype.slice.call(this.files);

            // 为空直接阻止
            if(!files.length){
                return false;
            }

            count += files.length;
            
            // 最多可上传的图片数量
            if (count > 9) {
                alert("最多只可上传9张图片");
                count -= files.length;

                return false;
            }

            // 对files数组对象遍历
            files.forEach(function(file, i) {
                if (!/\/(?:jpeg|png|gif)/i.test(file.type)){
                    return false;
                }

                var reader = new FileReader();

                reader.onload = function () {
                    var result = this.result;
                    var img = new Image();
                    var cont = imgCont.clone(true).removeClass("first");

                    img.src = result;

                    // 如果图片大小小于200kb，则直接上传
                    if (result.length <= maxsize) {
                        cont.find(".file-img").attr("src", result);
                        sendVal += "," + result;
                        img = null;
                        upload(result, file.type, cont);

                        return false;
                    }

                    // 图片加载完毕之后进行压缩，然后上传
                    if (img.complete) {
                        callback();
                    } else {
                        img.onload = callback;
                    }

                    function callback() {
                        // compress压缩处理
                        var data = compress(img);

                        cont.find(".file-img").attr("src", result);
                        sendVal += "|" + data;
                        img = null;
                        upload(data, file.type, cont);
                    }

                    fileBtn.before(cont);
                    // 上传完成后清空input，解决删除后再上传同一张图片上传不上的问题
                    clearFileValue(fileChooser);
                };

                reader.readAsDataURL(file);
            });
        });

        $(".close").on("click", function(){
            var str = $(this).prev().attr("src");
            
            $(this).parent().remove();
            count -= 1;
            clearFileValue(fileChooser);
        });

        function compress(img) {
            var initSize = img.src.length;
            var width = img.width;
            var height = img.height;
            
            // 用于压缩图片的canvas
            var canvas = document.createElement("canvas");
            var ctx = canvas.getContext('2d');

            // 瓦片canvas
            var tCanvas = document.createElement("canvas");
            var tctx = tCanvas.getContext("2d");

            // 如果图片大于四百万像素，计算压缩比并将大小压至400万以下
            var ratio;
            if ((ratio = width * height / 4000000)>1) {
                ratio = Math.sqrt(ratio);
                width /= ratio;
                height /= ratio;
            }else {
                ratio = 1;
            }

            canvas.width = width;
            canvas.height = height;

            // 铺底色,
            ctx.fillStyle = "#fff";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 如果图片像素大于100万则使用瓦片绘制
            var count;
            if ((count = width * height / 1000000) > 1) {
                //计算要分成多少块瓦片
                count = ~~(Math.sqrt(count)+1);

                // 计算每块瓦片的宽和高
                var nw = ~~(width / count);
                var nh = ~~(height / count);

                tCanvas.width = nw;
                tCanvas.height = nh;

                for (var i = 0; i < count; i++) {
                    for (var j = 0; j < count; j++) {
                        tctx.drawImage(img, i * nw * ratio, j * nh * ratio, nw * ratio, nh * ratio, 0, 0, nw, nh);

                        ctx.drawImage(tCanvas, i * nw, j * nh, nw, nh);
                    }
                }
            } else {
                ctx.drawImage(img, 0, 0, width, height);
            }

            //进行最小压缩
            var ndata = canvas.toDataURL('image/jpeg', 0.5);

            // console.log('压缩前：' + initSize);
            // console.log('压缩后：' + ndata.length);
            // console.log('压缩率：' + ~~(100 * (initSize - ndata.length) / initSize) + "%");

            tCanvas.width = tCanvas.height = canvas.width = canvas.height = 0;

            return ndata;
        }
        // 图片上传，将base64的图片转成二进制对象，塞进formdata上传
        function upload(basestr, type, cont) {
            // var text = window.atob(basestr.split(",")[1]);
            var text = basestr.split(",")[1];
            // var buffer = new Uint8Array(text.length);
            // var pecent = 0,
            //     loop = null;
            // for (var i = 0; i < text.length; i++) {
            //     buffer[i] = text.charCodeAt(i);
            // }

            // var blob = getBlob([buffer], type);

            var xhr = new XMLHttpRequest();
            var formdata = getFormData();

            formdata.append('imagefile', text);

            xhr.open('post', '/cupLoad');
            
            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    console.log('上传成功：' + xhr.responseText);

                    // clearInterval(loop);

                    //当收到该消息时上传完毕
                    // cont.find(".progress span").animate({'width': "100%"}, pecent < 95 ? 200 : 0, function () {
                    //     $(this).html("上传成功");
                    // });

                    // cont.find(".file-img").attr("src", xhr.responseText);
                    // fileBtn.before(cont);
                }
            };

            // //数据发送进度，前50%展示该进度
            // xhr.upload.addEventListener('progress', function (e) {
            //     if (loop) return;

            //     pecent = ~~(100 * e.loaded / e.total) / 2;
            //     cont.find(".progress span").css('width', pecent + "%");

            //     if (pecent == 50) {
            //         mockProgress();
            //     }
            // }, false);

            // //数据后50%用模拟进度
            // function mockProgress() {
            //     if (loop) return;

            //     loop = setInterval(function () {
            //         pecent++;
            //         cont.find(".progress span").css('width', pecent + "%");

            //         if (pecent == 99) {
            //             clearInterval(loop);
            //         }
            //     }, 100)
            // }

            xhr.send(formdata);
        }
        /**
         * 获取blob对象的兼容性写法
         * @param buffer
         * @param format
         * @returns {*}
         */
        function getBlob(buffer, format) {
            try {
                return new Blob(buffer, {
                    type: format
                });
            } catch (e) {
                var bb = new(window.BlobBuilder || window.WebKitBlobBuilder || window.MSBlobBuilder);
                buffer.forEach(function(buf) {
                    bb.append(buf);
                });
                return bb.getBlob(format);
            }
        }
        /**
         * 获取formdata
         */
        function getFormData() {
            var isNeedShim = ~navigator.userAgent.indexOf('Android') &&
                ~navigator.vendor.indexOf('Google') &&
                !~navigator.userAgent.indexOf('Chrome') &&
                navigator.userAgent.match(/AppleWebKit\/(\d+)/).pop() <= 534;
            return isNeedShim ? new FormDataShim() : new FormData()
        }
        /**
         * formdata 补丁, 给不支持formdata上传blob的android机打补丁
         * @constructor
         */
        function FormDataShim() {
            console.warn('using formdata shim');
            var o = this,
                parts = [],
                boundary = Array(21).join('-') + (+new Date() * (1e16 * Math.random())).toString(36),
                oldSend = XMLHttpRequest.prototype.send;
            this.append = function(name, value, filename) {
                parts.push('--' + boundary + '\r\nContent-Disposition: form-data; name="' + name + '"');
                if (value instanceof Blob) {
                    parts.push('; filename="' + (filename || 'blob') + '"\r\nContent-Type: ' + value.type + '\r\n\r\n');
                    parts.push(value);
                } else {
                    parts.push('\r\n\r\n' + value);
                }
                parts.push('\r\n');
            };
            // Override XHR send()
            XMLHttpRequest.prototype.send = function(val) {
                var fr,
                    data,
                    oXHR = this;
                if (val === o) {
                    // Append the final boundary string
                    parts.push('--' + boundary + '--\r\n');
                    // Create the blob
                    data = getBlob(parts);
                    // Set up and read the blob into an array to be sent
                    fr = new FileReader();
                    fr.onload = function() {
                        oldSend.call(oXHR, fr.result);
                    };
                    fr.onerror = function(err) {
                        throw err;
                    };
                    fr.readAsArrayBuffer(data);
                    // Set the multipart content type and boudary
                    this.setRequestHeader('Content-Type', 'multipart/form-data; boundary=' + boundary);
                    XMLHttpRequest.prototype.send = oldSend;
                } else {
                    oldSend.call(this, val);
                }
            };
        }

        // 清空file,file为jq对象
        function clearFileValue(file) {
            file.wrap('<form></form>');
            file.parent()[0].reset();
            file.unwrap();
        }
    }());
</script>
{% endblock %}
